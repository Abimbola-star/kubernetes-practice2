# Setting Up RBAC for a New User in Amazon EKS

**Important Note**: This lab should be done in the EKS cluster launched with eksctl.

## **Overview**

We have a new user called **Adam** in dev team and we need to give him access to the cluster resources. As an administrator, setup RBAC to allow Adam to list, create and delete pods in the dev namespace. 

This guide explains how to configure **Role-Based Access Control (RBAC)** in an **Amazon EKS** cluster to allow a new team member to **only create, delete and list pods** in the `dev` namespace.

---

## **Step 1: Create an IAM User and Get Their ARN**

Here, we must create a user called **Adam** in the group **dev-group** then attach the **eks:DescribeCluster** policy to the user to allow authentication to EKS. Use the terraform code in the `iam-user-terraform` folder.


## **Step 2: Map the IAM group to a Kubernetes group**
Amazon EKS does not automatically assign permissions to IAM users or groups, so we must update the `aws-auth` ConfigMap.

1. Open a terminal and run:

   ```sh
   eksctl create iamidentitymapping \
  --cluster my-cluster \
  --region us-east-1 \
  --arn "arn:aws:iam::123456789012:group/dev-group" \
  --group dev-group \
  --username dev-team
   ```
This command will map the IAM group to a Kubernetes group

   Replace `arn:aws:iam::123456789012:group/dev-group` with the actual IAM ARN.

---

## **Step 3: Create a Kubernetes Role (RBAC)**
Now, create a Kubernetes **Role** in the `dev` namespace to define permissions.

1. First create the namespace dev in your cluster: 
```bash
kubectl create ns dev
```

2. Create the role and the rolebinding for the user. Create a manifest file and paste the content of `dev-rbac-eks-setup.yaml`

3. Apply the manifest to the cluster:

   ```sh
   kubectl apply -f dev-rbac-eks-setup.yaml
   ```

---

## **Step 4: Verify access (User side)**

On Adam's side, he must make sure AWS CLI is installed and configured with access keys and secret keys on his local computer. He must also install `kubectl` to be able to interact with kubernetes clusters.
1. Configure AWS CLI with IAM User Credentials (generated by the script we ran ealier)
Verify
```bash
aws --version
kubectl version --client
aws configure
# Enter the IAM user's Access Key ID and Secret Access Key.
# Set the default region to match the EKS cluster's region in this case us-east-1
aws sts get-caller-identity
# It should return IAM User ARN.
```
2. Update kubeconfig for Cluster Access
Once the AWS CLI is configured, Adam must update his kubeconfig file to authenticate with the EKS cluster.

´´´bash
aws eks update-kubeconfig --region <region> --name <cluster-name>
´´´
Replace <region> and <cluster-name> with the actual values. Example:
´´´bash
aws eks update-kubeconfig --region us-east-1 --name my-cluster
´´´

3. verify access
```bash
kubectl get pods
kubectl get pods -n dev
kubectl auth can-i create pods --namespace=dev
kubectl auth can-i delete pods --namespace=dev
kubectl auth can-i create deployment --namespace=dev
kubectl auth can-i delete service --namespace=dev
```
It should return "yes" for the objects he can create or "no" for the ones he cannot create.

If Adam tries to create a deployment, a service or even list nodes he will get a Forbidden error.

# Clean Up

At the end of the practice, always delete resources created.
**Note: If you configured Adam IAM credentials in your terminal to practice this lab, remember to reconfigure aws cli with your normal IAM user account credentials to be able to continue managing your resources.**

To delete the resources created by the `create-eks-user.sh` script, you can use the `delete-eks-user.sh` script present in this same folder.
You can verify that the user was successfully delete with the command (if the username was Adam):

```bash
aws iam get-user --user-name Adam
```
